<!--
     @license
     Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
     This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
     The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
     The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
     Code distributed by Google as part of the polymer project is also
     subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
   -->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<dom-module id="list-task">
  <template>
    <style>
     :host {
       display: block;
     }
     .summarycard {
       padding:2em;
       margin-left: 3vw;
     }
     paper-dialog {
       padding:2em;
     }
     paper-checkbox {
       display: inline-block;
       margin: 5px 0;
       transition: opacity 0.3s;
     }

     paper-checkbox[checked] {
       opacity: 0.5;
     }
     paper-icon-button {
       position:absolute;
       bottom:-2px;
       left:-2px;
       opacity:0.1;
     }
     paper-icon-button:hover {
       opacity:1;
     }
    </style>
    <iron-ajax url="[[deleteUrl]]" method="delete" id="ajaxdelete"
               handle-as="json"
               on-response="handleResponse" ></iron-ajax>
    <iron-ajax url="/api/tasks/" method="put" id="ajaxupdate"
               handle-as="json" ></iron-ajax>
    <paper-dialog id="deletedialog" >
      <h2 style="text-align:center">Really Delete?</h2>
      <span class="dialogbuttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-click="deleteItem">Delete</paper-button>
      </span>
    </paper-dialog>
    <paper-material elevation="1" class="summarycard">
      <template is="dom-if" if="{{!editing}}">
          <paper-checkbox on-change="toggleItem"
                          checked="{{done}}">
          </paper-checkbox>
            <span on-dblclick="editItem">[[summary]]</span>
          <paper-icon-button icon="delete"
                             on-click="deleteRequest">
          </paper-icon-button>
      </template>
      <template is="dom-if" if="{{editing}}">
        <paper-input  value="{{summary}}" on-keyup="editTask" on-blur="blurAction"
                      id="editSummary"></paper-input>
      </template>
    </paper-material>
  </template>
  <script>
   (function() {
     'use strict';

     Polymer({
       is: 'list-task',

       properties: {
         summary: {
           type: String
         },
         done: {
           type: Boolean
         },
         taskid: {
           type: String
         },

       },
       ready: function() {
         this.editing = false;
         this.deleteUrl = '/api/tasks/' + this.taskid;
       },
       deleteRequest: function() {
         this.$.deletedialog.toggle();
       },
       deleteItem: function(data) {
         this.$.ajaxdelete.generateRequest();
       },
       toggleItem: function() {
         this.$.ajaxupdate.body= JSON.stringify({
           "summary" : this.summary,
           "done" : this.done,
           "id" : this.taskid
         });
         this.$.ajaxupdate.generateRequest();
       },
       editItem: function() {
         this.editing = !this.editing;
       },
       editTask: function(e) {
         if (e.keyCode === 27) {
           this.editing = !this.editing;
         }
         if (e.keyCode === 13) {
           this.toggleItem();
           this.editing = !this.editing;
         }
       },
       blurAction: function(e) {
         this.editing = false;
       },
       handleResponse: function(request) {
         this.fire('delete', this.taskid);
       },
       

     });
   })();
  </script>
</dom-module>
